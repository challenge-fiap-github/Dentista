<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OdontoVision - Dashboard Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f4f8; }
        
        .header {
            background: linear-gradient(135deg, #0066cc 0%, #00a86b 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .container { max-width: 1600px; margin: 30px auto; padding: 0 20px; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #0066cc;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.12);
        }
        
        .stat-card h3 { color: #6b7280; font-size: 0.9em; margin-bottom: 5px; }
        .stat-card p { font-size: 2em; font-weight: bold; color: #1f2937; }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0066cc;
        }
        
        .filters { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }
        
        .filters input, .filters select { 
            padding: 10px; 
            border: 2px solid #e5e7eb; 
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .filters input:focus, .filters select:focus {
            outline: none;
            border-color: #0066cc;
        }
        
        .filters select { min-width: 200px; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%); 
            color: white; 
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); 
            color: white; 
        }
        
        .btn-success { 
            background: linear-gradient(135deg, #00a86b 0%, #008c5a 100%); 
            color: white; 
        }
        
        .btn-warning { 
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); 
            color: #333; 
        }
        
        .btn-info { 
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); 
            color: white; 
        }
        
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); 
        }
        
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none; 
        }
        
        .table { width: 100%; border-collapse: collapse; }
        .table th { 
            background: #f9fafb; 
            padding: 12px; 
            text-align: left; 
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            color: #374151;
        }
        .table td { 
            padding: 12px; 
            border-bottom: 1px solid #e5e7eb; 
            color: #4b5563;
        }
        .table tr:hover { background: #f9fafb; }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        /* Paleta de cores para os status */
        .badge-novo { 
            background: linear-gradient(135deg, #e9d5ff 0%, #f3e8ff 100%); 
            color: #6b21a8; 
            border: 1px solid #c084fc;
        }

        .badge-pending { 
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); 
            color: #3730a3; 
            border: 1px solid #a5b4fc;
        }

        .badge-warning { 
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); 
            color: #92400e; 
            border: 1px solid #fbbf24;
        }

        .badge-danger { 
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); 
            color: #991b1b; 
            border: 1px solid #f87171;
        }

        .badge-success { 
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); 
            color: #065f46; 
            border: 1px solid #34d399;
        }

        .badge-info { 
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); 
            color: #1e40af; 
            border: 1px solid #60a5fa;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .modal-header h3 { color: #1f2937; }
        
        .close-btn { 
            background: none; 
            border: none; 
            font-size: 1.5em; 
            cursor: pointer; 
            color: #9ca3af; 
        }
        
        .close-btn:hover { color: #4b5563; }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-group label { 
            display: block; 
            font-weight: 600; 
            color: #6b7280; 
            margin-bottom: 5px; 
        }
        
        .info-group p { 
            color: #1f2937; 
            padding: 8px; 
            background: #f9fafb; 
            border-radius: 5px; 
            border: 1px solid #e5e7eb;
        }
        
        .alert-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .alert-box h4 { color: #92400e; margin-bottom: 5px; }
        .alert-box p { color: #78350f; }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .chart-container { padding: 20px; }
        
        .expand-btn { 
            background: none; 
            border: none; 
            color: #0066cc; 
            cursor: pointer; 
            font-size: 1.2em;
            padding: 5px 10px;
            transition: color 0.3s;
        }
        
        .expand-btn:hover { color: #0052a3; }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #374151;
        }
        
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 120px;
            transition: border-color 0.3s;
        }
        
        .form-group textarea:focus {
            outline: none;
            border-color: #0066cc;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #6b7280;
        }
        
        .empty-state p {
            font-size: 1.1em;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-weight: 600;
            position: relative;
            transition: color 0.3s;
        }
        
        .tab:hover {
            color: #0066cc;
        }
        
        .tab.active {
            color: #0066cc;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #0066cc;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-indicator.pending { background: #f59e0b; }
        .status-indicator.approved { background: #10b981; }
        .status-indicator.rejected { background: #ef4444; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ü¶∑ OdontoVision - Dashboard Administrativo</h1>
            <div>
                <span id="userName" style="margin-right: 15px;"></span>
                <button class="logout-btn" onclick="logout()">Sair</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total de Registros</h3>
                <p id="totalRegistros">0</p>
            </div>
            <div class="stat-card" style="border-left-color: #f59e0b;">
                <h3>Em An√°lise</h3>
                <p id="emAnalise">0</p>
            </div>
            <div class="stat-card" style="border-left-color: #ef4444;">
                <h3>Fraudes Confirmadas</h3>
                <p id="fraudesConfirmadas">0</p>
            </div>
            <div class="stat-card" style="border-left-color: #10b981;">
                <h3>Acur√°cia do ML</h3>
                <p id="acuraciaML">0%</p>
            </div>
        </div>

        <div class="card">
            <h2>üìà An√°lise Gr√°fica</h2>
            <div class="charts-grid">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üö® Gest√£o de Alertas</h2>
            
            <div class="tabs">
                <button class="tab active" onclick="changeTab('pendente')">
                    <span class="status-indicator pending"></span>
                    Pendentes
                </button>
                <button class="tab" onclick="changeTab('aprovado')">
                    <span class="status-indicator approved"></span>
                    Aprovados
                </button>
                <button class="tab" onclick="changeTab('fraude')">
                    <span class="status-indicator rejected"></span>
                    Fraudes
                </button>
                                <button class="tab" onclick="changeTab('todos')">
                    Todos
                </button>
            </div>
            
            <div class="filters">
                <input type="text" id="searchInput" placeholder="Buscar por paciente, dentista ou CPF..." onkeyup="loadAlertas()">
            </div>
            
            <div id="alertasContainer">
                <div class="empty-state">
                    <h3>üìã Carregando dados...</h3>
                    <p>Aguarde enquanto carregamos os registros.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Detalhes da Consulta</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Modal de Contato com Dentista -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìß Contatar Dentista</h3>
                <button class="close-btn" onclick="closeContactModal()">&times;</button>
            </div>
            <div id="contactModalContent">
                <div class="info-group">
                    <label>Dentista:</label>
                    <p id="contactDentistName"></p>
                </div>
                <div class="info-group">
                    <label>Email:</label>
                    <p id="contactDentistEmail"></p>
                </div>
                <div class="form-group">
                    <label>Mensagem:</label>
                    <textarea id="contactMessage" placeholder="Digite sua mensagem para o dentista..."></textarea>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-info" onclick="enviarEmailDentista()">üìß Enviar Email</button>
                    <button class="btn" onclick="closeContactModal()">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5001';
        let currentConsultaId = null;
        let currentDentistaEmail = '';
        let currentTab = 'pendente';

        function checkAuth() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (!token || user.role !== 'admin') {
                window.location.href = 'login.html';
                return false;
            }
            document.getElementById('userName').textContent = user.name;
            return true;
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        function changeTab(tab) {
            currentTab = tab;
            
            // Atualizar visual das tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Carregar dados da tab
            loadAlertas();
        }

        async function loadDashboardStats() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/admin/dashboard/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Erro ao carregar estat√≠sticas');
                
                const data = await response.json();

                document.getElementById('totalRegistros').textContent = data.total_registros || 0;
                document.getElementById('emAnalise').textContent = data.em_analise || 0;
                document.getElementById('fraudesConfirmadas').textContent = data.fraudes_confirmadas || 0;
                document.getElementById('acuraciaML').textContent = data.ml_metrics?.accuracy 
                    ? (data.ml_metrics.accuracy * 100).toFixed(1) + '%' 
                    : '0%';

                // Gr√°fico de Status com cores espec√≠ficas por tipo
                if (data.por_status && Object.keys(data.por_status).length > 0) {
                    const statusCtx = document.getElementById('statusChart').getContext('2d');
                    
                    // Mapear cores espec√≠ficas para cada status
                    const statusColors = {
                        'normal': '#0066cc',      // Azul
                        'novo': '#6b21a8',         // Azul
                        'aprovado': '#00a86b',     // Verde
                        'legitimo': '#00a86b',     // Verde
                        'atencao': '#ffc107',      // Amarelo
                        'pendente': '#ffc107',     // Amarelo
                        'em_analise': '#17a2b8',   // Ciano (azul claro)
                        'fraude': '#dc3545',       // Vermelho
                        'reprovado': '#dc3545'     // Vermelho
                    };
                    
                    // Criar arrays de labels e cores baseados nos dados recebidos
                    const labels = Object.keys(data.por_status);
                    const colors = labels.map(status => statusColors[status] || '#6c757d'); // Cinza como fallback
                    
                    new Chart(statusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: labels.map(s => formatStatus(s)),
                            datasets: [{
                                data: Object.values(data.por_status),
                                backgroundColor: colors,
                                borderColor: '#ffffff',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return `${label}: ${value} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Gr√°fico Timeline com cores azul e verde
                if (data.timeline && data.timeline.length > 0) {
                    const timelineCtx = document.getElementById('timelineChart').getContext('2d');
                    new Chart(timelineCtx, {
                        type: 'line',
                        data: {
                            labels: data.timeline.map(t => t.mes_ano),
                            datasets: [{
                                label: 'Total',
                                data: data.timeline.map(t => t.total),
                                borderColor: '#0066cc',
                                backgroundColor: 'rgba(0, 102, 204, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#0066cc',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }, {
                                label: 'Suspeitos',
                                data: data.timeline.map(t => t.suspeitos),
                                borderColor: '#ffc107',  // Amarelo para suspeitos
                                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#ffc107',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }


        async function loadAlertas() {
            try {
                const token = localStorage.getItem('token');
                const search = document.getElementById('searchInput').value || '';

                // Mapear tabs para status (incluir estados relacionados)
                let statusFilter = '';
                switch (currentTab) {
                    case 'pendente':
                        statusFilter = 'pendente,atencao,em_analise,novo';
                        break;
                    case 'aprovado':
                        statusFilter = 'aprovado,legitimo,normal';
                        break;
                    case 'fraude':
                        statusFilter = 'reprovado,fraude';
                        break;
                    case 'todos':
                    default:
                        statusFilter = '';
                        break;
                }

                console.log('Carregando alertas com filtro:', statusFilter, 'search:', search);

                const url = `${API_URL}/api/admin/alertas?status=${encodeURIComponent(statusFilter)}&search=${encodeURIComponent(search)}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                // Ler o corpo como texto primeiro e validar JSON explicitamente
                const contentType = response.headers.get('content-type') || '';
                const responseText = await response.text();
                let data;

                try {
                    if (contentType.includes('application/json')) {
                        data = JSON.parse(responseText);
                    } else {
                        // Tentar fazer parse mesmo que o header n√£o esteja correto
                        data = JSON.parse(responseText);
                    }
                } catch (parseErr) {
                    console.error('Erro ao fazer parse do JSON:', parseErr, responseText);
                    throw new Error('Resposta do servidor n√£o √© JSON v√°lido');
                }

                if (!response.ok) {
                    console.error('Erro na resposta do servidor:', response.status, data);
                    throw new Error(data.error || 'Erro ao carregar alertas');
                }

                console.log('Dados recebidos:', data);

                if (!data.alertas || !Array.isArray(data.alertas) || data.alertas.length === 0) {
                    document.getElementById('alertasContainer').innerHTML = `
                        <div class="empty-state">
                            <h3>üìã Nenhum registro encontrado</h3>
                            <p>N√£o h√° alertas para os filtros selecionados.</p>
                            <button class="btn btn-primary" onclick="window.location.reload()">üîÑ Recarregar P√°gina</button>
                        </div>
                    `;
                    return;
                }

                // Renderizar tabela com colunas claras e bot√µes seguros
                const html = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Data</th>
                                <th>Paciente</th>
                                <th>Dentista</th>
                                <th>Procedimento</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.alertas.map(a => {
                                const statusClass = getStatusClass(a.status);
                                const canEdit = ['pendente', 'atencao', 'em_analise', 'novo'].includes(a.status);
                                const created = a.created_at ? new Date(a.created_at) : null;
                                const createdStr = created && !isNaN(created) ? created.toLocaleDateString('pt-BR') : '-';
                                const paciente = a.paciente_nome || '-';
                                const dentista = a.dentista || '-';
                                const procedimento = a.procedimento || '-';
                                const id = (a.id !== undefined && a.id !== null) ? a.id : '-';

                                return `
                                    <tr>
                                        <td>#${id}</td>
                                        <td>${createdStr}</td>
                                        <td>${paciente}</td>
                                        <td>${dentista}</td>
                                        <td>${procedimento}</td>
                                        <td><span class="badge ${statusClass}">${formatStatus(a.status)}</span></td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button class="expand-btn" onclick="openModal(${id})" title="Ver detalhes">üëÅÔ∏è</button>
                                                ${canEdit ? `
                                                    <button class="expand-btn" style="color: #10b981;" onclick="classificar(${id}, 'legitimo')" title="Aprovar">‚úÖ</button>
                                                    <button class="expand-btn" style="color: #ef4444;" onclick="classificar(${id}, 'fraude')" title="Marcar como fraude">üö´</button>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;

                document.getElementById('alertasContainer').innerHTML = html;

            } catch (error) {
                console.error('Erro ao carregar alertas:', error);
                const message = error && error.message ? error.message : 'Erro desconhecido ao carregar alertas.';
                document.getElementById('alertasContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>‚ö†Ô∏è Erro ao carregar dados</h3>
                        <p>${message}</p>
                        <div style="margin-top: 12px; display:flex; gap:8px; justify-content:center;">
                            <button class="btn btn-primary" onclick="loadAlertas()">üîÑ Tentar Novamente</button>
                            <button class="btn" onclick="logout()">‚èèÔ∏è Sair</button>
                        </div>
                    </div>
                `;
            }
        }

        function getStatusClass(status) {
            const statusMap = {
                'novo': 'badge-novo',        // Roxo
                'pendente': 'badge-pending',  // Azul √≠ndigo
                'atencao': 'badge-warning',   // Amarelo
                'em_analise': 'badge-info',   // Azul claro
                'aprovado': 'badge-success',  // Verde
                'legitimo': 'badge-success',  // Verde
                'normal': 'badge-success',    // Verde
                'reprovado': 'badge-danger',  // Vermelho
                'fraude': 'badge-danger'      // Vermelho
            };
            return statusMap[status] || 'badge-info';
        }

        function formatStatus(status) {
            const statusMap = {
                'pendente': 'Pendente',
                'atencao': 'Aten√ß√£o',
                'em_analise': 'Em An√°lise',
                'aprovado': 'Aprovado',
                'legitimo': 'Leg√≠timo',
                'reprovado': 'Reprovado',
                'fraude': 'Fraude',
                'normal': 'Normal',
                'novo': 'Novo'
            };
            return statusMap[status] || status;
        }

        async function openModal(id) {
            try {
                // Garantir que o ID √© um n√∫mero
                const consultaId = parseInt(id);
                if (isNaN(consultaId)) {
                    console.error('ID inv√°lido:', id);
                    alert('ID da consulta inv√°lido!');
                    return;
                }
                
                currentConsultaId = consultaId;
                const token = localStorage.getItem('token');
                
                console.log('Abrindo modal para consulta ID:', consultaId);
                
                const response = await fetch(`${API_URL}/api/admin/consulta/${consultaId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Erro ao carregar consulta');
                }
                
                const data = await response.json();
                const c = data.consulta;
                
                // Verificar se os dados existem
                if (!c) {
                    throw new Error('Dados da consulta n√£o encontrados');
                }
                
                // Armazenar email do dentista
                currentDentistaEmail = c.dentista_email || '';

                const canApprove = ['pendente', 'atencao', 'em_analise', 'novo', 'normal'].includes(c.status);

                // Formatar CPF para exibi√ß√£o
                const formatCPF = (cpf) => {
                    if (!cpf) return '-';
                    const cpfStr = cpf.toString().padStart(11, '0');
                    return cpfStr.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                };

                document.getElementById('modalContent').innerHTML = `
                    <div class="info-grid">
                        <div class="info-group">
                            <label>ID da Consulta:</label>
                            <p>#${c.id || consultaId}</p>
                        </div>
                        <div class="info-group">
                            <label>Paciente:</label>
                            <p>${c.paciente_nome || '-'}</p>
                        </div>
                        <div class="info-group">
                            <label>CPF:</label>
                            <p>${formatCPF(c.cpf)}</p>
                        </div>
                        <div class="info-group">
                            <label>Data:</label>
                            <p>${c.created_at ? new Date(c.created_at).toLocaleString('pt-BR') : '-'}</p>
                        </div>
                        <div class="info-group">
                            <label>Dentista:</label>
                            <p>${c.dentista || '-'}</p>
                        </div>
                        <div class="info-group">
                            <label>Email Dentista:</label>
                            <p>${c.dentista_email || 'N√£o dispon√≠vel'}</p>
                        </div>
                        <div class="info-group">
                            <label>CRO:</label>
                            <p>${c.cro_dentista || '-'}</p>
                        </div>
                        <div class="info-group">
                            <label>Procedimento:</label>
                            <p>${c.procedimento || '-'}</p>
                        </div>
                        <div class="info-group">
                            <label>Dente:</label>
                            <p>${c.dente || '-'}</p>
                        </div>
                        <div class="info-group">
                            <label>Status Atual:</label>
                            <p><span class="badge ${getStatusClass(c.status)}">${formatStatus(c.status)}</span></p>
                        </div>
                    </div>
                    
                    ${c.motivo_atencao ? `
                        <div class="alert-box">
                            <h4>‚ö†Ô∏è Motivos de Aten√ß√£o:</h4>
                            <p>${c.motivo_atencao}</p>
                        </div>
                    ` : ''}
                    
                    <div class="info-group">
                        <label>Execu√ß√£o do Procedimento:</label>
                        <p>${c.executado || '-'}</p>
                    </div>
                    
                    <div class="info-group">
                        <label>Prescri√ß√£o:</label>
                        <p>${c.prescricao || 'Sem prescri√ß√£o'}</p>
                    </div>
                    
                    ${data.stats_dentista ? `
                        <h4 style="margin: 20px 0 10px 0;">üìä Estat√≠sticas do Dentista</h4>
                        <div class="info-grid">
                            <div class="info-group">
                                <label>Total de Procedimentos:</label>
                                <p>${data.stats_dentista.total_procedimentos || 0}</p>
                            </div>
                            <div class="info-group">
                                <label>Procedimentos Suspeitos:</label>
                                <p>${data.stats_dentista.suspeitos || 0}</p>
                            </div>
                            <div class="info-group">
                                <label>Taxa de Suspeita:</label>
                                <p>${(data.stats_dentista.taxa_suspeita || 0).toFixed(1)}%</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${data.historico_paciente && data.historico_paciente.length > 1 ? `
                        <h4 style="margin: 20px 0 10px 0;">üìã Hist√≥rico do Paciente</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table class="table" style="font-size: 0.9em;">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Procedimento</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.historico_paciente.slice(0, 5).map(h => `
                                        <tr>
                                            <td>${new Date(h.created_at).toLocaleDateString('pt-BR')}</td>
                                            <td>${h.procedimento || '-'}</td>
                                            <td><span class="badge ${getStatusClass(h.status)}">${formatStatus(h.status)}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                    
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="classificar(${consultaId}, 'legitimo')" ${!canApprove ? 'disabled' : ''}>
                            ‚úÖ Aprovar
                        </button>
                        <button class="btn btn-danger" onclick="classificar(${consultaId}, 'fraude')" ${!canApprove ? 'disabled' : ''}>
                            üö´ Classificar como Fraude
                        </button>
                        <button class="btn btn-info" onclick="openContactModal('${c.dentista || ''}', '${c.dentista_email || ''}')">
                            üìß Contatar Dentista
                        </button>
                    </div>
                `;
                
                document.getElementById('detailModal').classList.add('active');
                
            } catch (error) {
                console.error('Erro ao abrir modal:', error);
                alert(`Erro ao carregar detalhes da consulta: ${error.message}`);
            }
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
            currentConsultaId = null;
        }

        function openContactModal(dentistName, dentistEmail) {
            if (!dentistEmail) {
                alert('Email do dentista n√£o dispon√≠vel!');
                return;
            }
            
            currentDentistaEmail = dentistEmail;
            document.getElementById('contactDentistName').textContent = dentistName;
            document.getElementById('contactDentistEmail').textContent = dentistEmail;
            document.getElementById('contactMessage').value = '';
            document.getElementById('contactModal').classList.add('active');
        }

        function closeContactModal() {
            document.getElementById('contactModal').classList.remove('active');
        }

        async function enviarEmailDentista() {
            const message = document.getElementById('contactMessage').value.trim();
            
            if (!message) {
                alert('Por favor, digite uma mensagem!');
                return;
            }

            if (!currentDentistaEmail) {
                alert('Email do dentista n√£o dispon√≠vel!');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/admin/contatar-dentista`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        consulta_id: currentConsultaId,
                        dentista_email: currentDentistaEmail,
                        mensagem: message
                    })
                });

                if (!response.ok) throw new Error('Erro ao enviar email');

                alert('‚úÖ Email enviado com sucesso!');
                closeContactModal();
                closeModal();
            } catch (error) {
                console.error('Erro ao enviar email:', error);
                alert('‚ùå Erro ao enviar email. Tente novamente.');
            }
        }

        async function classificar(id, classificacao) {
            const mensagens = {
                'legitimo': 'Deseja APROVAR este procedimento como leg√≠timo?',
                'fraude': 'Deseja CLASSIFICAR este procedimento como FRAUDE?'
            };

            if (!confirm(mensagens[classificacao])) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/api/admin/classificar/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ classificacao })
                });

                if (!response.ok) throw new Error('Erro ao classificar');

                alert('‚úÖ Classifica√ß√£o realizada com sucesso!');
                closeModal();
                loadAlertas();
                loadDashboardStats();
            } catch (error) {
                console.error('Erro ao classificar:', error);
                alert('‚ùå Erro ao realizar classifica√ß√£o!');
            }
        }

        // Inicializa√ß√£o
        if (checkAuth()) {
            loadDashboardStats();
            loadAlertas();
        }
    </script>
</body>
</html>
